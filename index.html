<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>メダカ予約注文</title>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css"/>

<link rel="stylesheet" href="css/style.css">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
<style>
  /* プルダウンメニューのスタイル */
  select {
    text-align: center; /* テキストを中央に揃える */
    text-align-last: center; /* 最後の選択肢も中央に揃える */
  }

  /* プルダウンメニューのアイテムのスタイル */
  select option {
    text-align: center; /* アイテムのテキストも中央に揃える */
  }

  /* スライダーのスタイル */
  .slider {
    width: 80%; /* スライダーの幅 */
    margin: 20px auto; /* スライダーを中央に配置 */
  }

  .slider img {
    width: 100%; /* 画像の幅をスライダーに合わせる */
    height: auto; /* 高さを自動調整 */
  }

  .thumbnail-slider {
    width: 80%; /* サムネイルスライダーの幅 */
    margin: 20px auto; /* サムネイルスライダーを中央に配置 */
  }

  .thumbnail-slider img {
    width: 100px; /* サムネイルの幅 */
    height: auto; /* 高さを自動調整 */
    cursor: pointer; /* マウスポインタを表示 */
  }

  /* 大きなチェックボックスのスタイル */
  input[type="checkbox"] {
    transform: scale(2); /* サイズを2倍にする */
    margin-right: 1.5vw; /* チェックボックスとラベルの間にスペースを追加 */
  }

  label {
    font-size: 5vw; /* チェックボックスラベルのフォントサイズを調整 */
  }

  #loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4vw;
    z-index: 9999;
  }

  #submit-button {
    padding: 1vw 5vw; 
    font-size: 8vw; 
    border: 2px solid #4CAF50; 
    background-color: #eee; 
    color: black; 
    border-radius: 5px; 
    cursor: pointer; 
    border-color: black; 
  }
  #submit-button:disabled {
    background-color: #eee; 
    cursor: not-allowed; 
    color: #ccc; 
    border-color: #ccc; 
  }

  hr {
    height: 0;
    margin: 0;
    padding: 0;
    border: 0;
  }

  /* 実線 */
  .hr1 {
    border-top: 1px solid #aaa;
  }

  #main-content {
    display: none;
  }
</style>
</head>
<body>
  <div id="loading">Loading...</div>
  <div id="main-content">
    <h1 class="goukei">メダカ予約注文</h1>
    
    <hr class="hr1">

    <h1>※ご希望の品種と数量、受取日を指定したうえで確定ボタンを押してください。</h1>
    <br>
    <form id="order-form">
      <h1>
        <label for="species">品種名:</label>
        <select id="species" name="species" required onchange="updateSlider()">
          <!-- Options will be populated dynamically -->
        </select><br>

        <label for="quantity">数量:</label>
        <select id="quantity" name="quantity" required onchange="updatePrice()">
          <option value="">匹数を選択</option>
          <option value="1">1匹</option>
          <option value="2">2匹</option>
          <option value="3">3匹</option>
          <option value="4">4匹</option>
          <option value="5">5匹</option>
        </select><br>
      </h1>

      <div class="slider">
        <!-- Images will be populated dynamically -->
      </div>

      <div class="thumbnail-slider">
        <!-- Thumbnails will be populated dynamically -->
      </div>

      <h1>↓　受取希望日を選択　↓</h1>
      <h1><input type="date" name="daytime" class="button" id="tomorrow" style="font-size:8vw" required onchange="toggleSubmitButton()"></h1>

      <h1 class="goukei">合計金額: <span id="total-price">0</span>円</h1>

      <h1 class="t"><br></h1>
      <h1 class="cp">
        <label for="agreement">
          <input type="checkbox" id="agreement" name="agreement" onchange="toggleSubmitButton()">
          期日までに受け取り来られなかった場合、CoCoポイントが10pt消失することに同意する。
        </label>
      </h1>

      <h1 class="top"><button type="button" id="submit-button" onclick="submitOrder()" disabled>確定</button></h1>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
  <script>
    let data = [];
    document.addEventListener('DOMContentLoaded', async () => {
      await start_aaa();

      fetch('https://script.google.com/macros/s/AKfycbwT4l4jtPtjIV7Jo6OV29nHfghrGTWvGPI7iW3/exec')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(result => {
          data = result.map(item => ({
            species: item[0],
            price: item[1],
            imageUrl: item[2]
          }));

          const d = new Date();
          d.setDate(d.getDate() + 2);
          document.getElementById("tomorrow").setAttribute("min", d.toISOString().substr(0, 10));
          const d1 = new Date();
          d1.setDate(d1.getDate() + 2 + 28);
          document.getElementById("tomorrow").setAttribute("max", d1.toISOString().substr(0, 10));

          populateSelect();
          initializeSlider();
          document.getElementById('loading').style.display = 'none'; // Hide loading screen
          document.getElementById('main-content').style.display = 'block'; // Show main content
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          document.getElementById('loading').innerText = 'データの取得に失敗しました'; // Show error message
        });
    });

    function populateSelect() {
      const select = document.getElementById('species');
      select.innerHTML = '<option value="">-- 品種を選択 --</option>'; // Default option
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.species;
        option.textContent = item.species;
        select.appendChild(option);
      });
    }

    function initializeSlider() {
      $('.slider').slick({
        dots: true,
        arrows: true,
        infinite: true,
        speed: 500,
        slidesToShow: 1,
        slidesToScroll: 1
      });

      $('.thumbnail-slider').slick({
        slidesToShow: 3,
        slidesToScroll: 1,
        asNavFor: '.slider',
        dots: false,
        arrows: false,
        centerMode: true,
        focusOnSelect: true
      });
    }

    function updateSlider() {
      const selectedSpecies = document.getElementById('species').value;
      const selectedItem = data.find(item => item.species === selectedSpecies);

      if (selectedItem) {
        const slider = $('.slider');
        slider.slick('slickRemove', null, null, true); // Remove all slides
        const img = document.createElement('img');
        img.src = selectedItem.imageUrl;
        img.alt = selectedSpecies;
        slider.slick('slickAdd', img);

        const thumbnailSlider = $('.thumbnail-slider');
        thumbnailSlider.slick('slickRemove', null, null, true); // Remove all thumbnails
        const thumbnail = document.createElement('img');
        thumbnail.src = selectedItem.imageUrl;
        thumbnail.alt = selectedSpecies;
        thumbnailSlider.slick('slickAdd', thumbnail);
      }

      updatePrice();
    }

    function updatePrice() {
      const selectedSpecies = document.getElementById('species').value;
      const quantity = parseInt(document.getElementById('quantity').value, 10);
      const selectedItem = data.find(item => item.species === selectedSpecies);

      if (selectedItem && quantity) {
        const totalPrice = selectedItem.price * quantity;
        document.getElementById('total-price').textContent = totalPrice.toLocaleString();
      } else {
        document.getElementById('total-price').textContent = '0';
      }

      toggleSubmitButton();
    }

    function toggleSubmitButton() {
      const species = document.getElementById('species').value;
      const quantity = document.getElementById('quantity').value;
      const agreement = document.getElementById('agreement').checked;
      const date = document.getElementById('tomorrow').value;

      const submitButton = document.getElementById('submit-button');
      if (species && quantity && agreement && date) {
        submitButton.disabled = false;
      } else {
        submitButton.disabled = true;
      }
    }

    async function submitOrder() {
      const species = document.getElementById('species').value;
      const quantity = document.getElementById('quantity').value;
      const date = document.getElementById('tomorrow').value;

      if (!species || !quantity || !date) {
        alert('全てのフィールドを入力してください。');
        return;
      }

      try {
        const response = await $.ajax({
          url: 'https://script.google.com/macros/s/AKfycbwT4l4jtPtjIV7Jo6OV29nHfghrGTWvGPI7iW3/exec',
          type: 'POST',
          data: {
            species: species,
            quantity: quantity,
            date: date,
          }
        });

        alert('注文が送信されました。');
      } catch (error) {
        console.error('Error submitting order:', error);
        alert('注文の送信に失敗しました。');
      }
    }

    async function start_aaa() {
      return new Promise((resolve, reject) => {
        liff.init({ liffId: '1657196041-ALeOLrEa' }, async () => {
          if (liff.isLoggedIn()) {
            const idToken = liff.getIDToken();
            $('#loading').show();

            try {
              const response = await $.ajax({
                url: 'https://script.google.com/macros/s/AKfycbz4I7jwbEU7UFqtoFQnCzVqKtG5xA9dBUw0s-jR8aBxbZ5LzIF8ISLXU7czUhVPYTBnjQ/exec',
                type: 'POST',
                data: { idToken: idToken },
              });

              console.log(response);
              const jsonData = JSON.parse(response);

              if (jsonData.rank === "シルバー") {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                resolve();
              } else {
                alert('シルバーランク以外使えません.');
                liff.closeWindow();
                reject('シルバーランク以外使えません.');
              }
            } catch (error) {
              console.error(error);
              alert('Failed to send ID Token to GAS.');
              liff.closeWindow();
              reject('Failed to send ID Token to GAS.');
            }
          } else {
            liff.login();
          }
        });
      });
    }
  </script>
</body>
</html>
